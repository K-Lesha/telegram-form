<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ò—Å—Ç–æ—Ä–∏—è</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }

    h2 {
      margin-bottom: 16px;
    }

    .entry-date {
      margin-top: 24px;
      font-weight: bold;
      font-size: 18px;
    }

    .entry {
      background: white;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .entry .project {
      font-weight: 600;
    }

    .entry .time {
      color: #777;
      margin-top: 4px;
    }

    .loading {
      font-style: italic;
      color: #888;
    }

    button {
      display: inline-block;
      padding: 10px 16px;
      margin: 6px 6px 12px 0;
      background-color: #007aff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #005fcc;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 12px;
      gap: 8px;
    }

    .active {
      background-color: #005fcc !important;
    }
  </style>
</head>
<body>
  <button onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  <div class="controls">
    <button id="btnEntries" onclick="showSection('entries')">üïò –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</button>
    <button id="btnVacations" onclick="showSection('vacations')">üèñ –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—É—Å–∫–æ–≤</button>
  </div>
  <h2 id="sectionTitle">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª</h2>
  <div id="content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

 <script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  document.body.style.backgroundColor = tg.themeParams.bg_color || '#f9f9f9';
  document.body.style.color = tg.themeParams.text_color || '#333';

  const content = document.getElementById('content');
  const title = document.getElementById('sectionTitle');
  const btnEntries = document.getElementById('btnEntries');
  const btnVacations = document.getElementById('btnVacations');

  let fullData = null;
  let currentSection = null; // üÜï –ß—Ç–æ –≤—ã–±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

  function getTelegramIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('telegram_id');
  }

  async function fetchData() {
    const telegram_id = getTelegramIdFromURL();
    if (!telegram_id) {
      content.textContent = '‚ùå –ù–µ —É–∫–∞–∑–∞–Ω Telegram ID –≤ URL.';
      return;
    }

    try {
      const res = await fetch('https://nip.setters-n8n.infinityfreeapp.com/webhook/fetch-timentries', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telegram_id })
      });

      const data = await res.json();
      
      if (!Array.isArray(data) || data.length === 0) {
        content.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
        return;
      }

      fullData = data[0];

      // üß† –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤—ã–±—Ä–∞–ª —Ä–∞–∑–¥–µ–ª ‚Äî —Å—Ä–∞–∑—É –µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      if (currentSection) {
        showSection(currentSection);
      } else {
        content.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤—ã—à–µ.';
      }

    } catch (err) {
      content.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
      console.error(err);
    }
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
      weekday: 'long'
    });
  }

  function showSection(section) {
    currentSection = section; // üÜï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
    btnEntries.classList.toggle('active', section === 'entries');
    btnVacations.classList.toggle('active', section === 'vacations');

    if (!fullData) {
      content.textContent = '‚è≥ –î–∞–Ω–Ω—ã–µ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...';
      return;
    }

    if (section === 'entries') {
      title.textContent = 'üïò –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π';
      renderEntries(fullData.time_entries_by_date);
    } else if (section === 'vacations') {
      title.textContent = 'üèñ –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—É—Å–∫–æ–≤';
      renderVacations(fullData.vacations);
    }
  }

function renderEntries(entriesByDate) {
  if (!entriesByDate || entriesByDate.length === 0) {
    content.innerHTML = '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —á–∞—Å–∞—Ö.</p>';
    return;
  }

  content.innerHTML = '';
  entriesByDate.sort((a, b) => new Date(b.date) - new Date(a.date));

  entriesByDate.forEach(group => {
    const dateEl = document.createElement('div');
    dateEl.className = 'entry-date';
    dateEl.textContent = formatDate(group.date);
    content.appendChild(dateEl);

    group.entries.forEach(e => {
      console.log('entry:', e); // üêû –æ—Ç–ª–∞–¥–∫–∞

      const div = document.createElement('div');
      div.className = 'entry';

      // Fallback: –µ—Å–ª–∏ –Ω–µ—Ç project_name ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º ID
      const name = e.project_name ?? `–ü—Ä–æ–µ–∫—Ç #${e.project_id}`;
      const hours = typeof e.hours === 'number' ? e.hours.toFixed(2) : '0.00';

      div.innerHTML = `
        <div class="project">${name}</div>
        <div class="time">${hours} —á</div>
      `;

      content.appendChild(div);
    });
  });
}

function renderVacations(vacations) {
  if (!Array.isArray(vacations) || vacations.length === 0) {
    content.innerHTML = '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ–± –æ—Ç–ø—É—Å–∫–∞—Ö.</p>';
    return;
  }

  content.innerHTML = '';
  vacations.forEach(v => {
    const start = v.start_date ? formatDate(v.start_date) : '‚Äî';
    const end = v.end_date ? formatDate(v.end_date) : '‚Äî';

    const div = document.createElement('div');
    div.className = 'entry';
    div.innerHTML = `
      <div class="project">–û—Ç–ø—É—Å–∫</div>
      <div class="time">${start} ‚Äì ${end}</div>
    `;
    content.appendChild(div);
  });
}

  function goBack() {
    window.parent.postMessage('close-history', '*');
  }

  fetchData();
</script>
</body>
</html>
