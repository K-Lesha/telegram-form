<!DOCTYPE html>
<html lang="ru">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ò—Å—Ç–æ—Ä–∏—è</title>
  <style>
    body { 
      font-family: system-ui, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }

    h2 {
      margin-bottom: 16px;
    }

    .entry-date {
      margin-top: 24px;
      font-weight: bold;
      font-size: 18px;
    }

    .entry {
      background: white;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .entry .project {
      font-weight: 600;
    }

    .entry .time {
      color: #777;
      margin-top: 4px;
    }

    .loading {
      font-style: italic;
      color: #888;
    }

    button {
      display: inline-block;
      padding: 10px 16px;
      margin: 6px 6px 12px 0;
      background-color: #007aff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s, opacity 0.2s;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    button:hover {
      background-color: #005fcc;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 12px;
      gap: 8px;
    }

    .active {
      background-color: #005fcc !important;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button id="btnEntries" onclick="showSection('entries')" disabled>üïò –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</button>
    <button id="btnVacations" onclick="showSection('vacations')" disabled>–ò—Å—Ç–æ—Ä–∏—è üèñ –æ—Ç–ø—É—Å–∫–æ–≤ –∏ üå° –±–æ–ª—å–Ω–∏—á–Ω—ã—Ö</button>
  </div>
  <h2 id="sectionTitle">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª</h2>
  <div id="content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    document.body.style.backgroundColor = tg.themeParams.bg_color || '#f9f9f9';
    document.body.style.color = tg.themeParams.text_color || '#333';

    const content = document.getElementById('content');
    const title = document.getElementById('sectionTitle');
    const btnEntries = document.getElementById('btnEntries');
    const btnVacations = document.getElementById('btnVacations');
    let userId = null;
    let fullData = null;
    let currentSection = null;

    async function fetchData() {
      btnEntries.disabled = true;
      btnVacations.disabled = true;

      let telegram_id = tg?.initDataUnsafe?.user?.id;

      if (!telegram_id) {
        content.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID.';
        return;
      }
      try {
        const res = await fetch('https://betters-technology.site/webhook/fetch-timentries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id })
        });

        if (!res.ok) {
          content.textContent = '‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É.';
          return;
        }

        const data = await res.json();
        fullData = data;
        userId = data.user_id;

        btnEntries.disabled = false;
        btnVacations.disabled = false;

        currentSection = 'entries';
        showSection(currentSection);

      } catch (err) {
        content.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
        content.innerHTML += `<pre>${err}</pre>`;
      }
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        weekday: 'long'
      });
    }

    function showSection(section) {
      currentSection = section;
      btnEntries.classList.toggle('active', section === 'entries');
      btnVacations.classList.toggle('active', section === 'vacations');

      if (!fullData) {
        content.textContent = '‚è≥ –î–∞–Ω–Ω—ã–µ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...';
        return;
      }

      if (section === 'entries') {
        title.textContent = 'üïò –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π';
        renderEntries(fullData.time_entries_by_date);
      } else if (section === 'vacations') {
        title.textContent = 'üèñ –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—É—Å–∫–æ–≤';
        renderVacations(fullData.vacations);
      }
    }

    function renderEntries(entriesByDate) {
      if (!Array.isArray(entriesByDate) || entriesByDate.length === 0) {
        content.innerHTML = '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —á–∞—Å–∞—Ö.</p>';
        return;
      }

      content.innerHTML = '';
      entriesByDate.sort((a, b) => new Date(b.date) - new Date(a.date));

      entriesByDate.forEach(group => {
        const dateEl = document.createElement('div');
        dateEl.className = 'entry-date';
        dateEl.textContent = formatDate(group.date);
        content.appendChild(dateEl);

        if (group.filled) {
          if (Array.isArray(group.entries)) {
            group.entries.forEach(e => {
              const div = document.createElement('div');
              div.className = 'entry';

              const name = e.project_name ?? `–ü—Ä–æ–µ–∫—Ç #${e.project_id ?? '?'}`;
              const hours = typeof e.hours === 'number' ? formatHoursPretty(e.hours) : '0—á00–º';

              div.innerHTML = `
                <div class="project">${name}</div>
                <div class="time">${hours}</div>
              `;

              content.appendChild(div);
            });
          }
        } else {
          const div = document.createElement('div');
          div.className = 'entry';
          div.innerHTML = `
            <div class="project">–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
            <div class="time">–ü—Ä–∏—á–∏–Ω–∞: ${group.not_filled_reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
            <button onclick="alert('–ü—Ä–∏—á–∏–Ω–∞: ${group.not_filled_reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}')">üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          `;
          content.appendChild(div);
        }

        const entryDate = new Date(group.date);
        const today = new Date();
        const diffInDays = (today - entryDate) / (1000 * 60 * 60 * 24);

        if (diffInDays <= 3 && group.filled) {
          const editBtn = document.createElement('button');
          editBtn.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
          editBtn.style.marginBottom = '10px';
          editBtn.onclick = () => enableEditMode(group);
          content.appendChild(editBtn);
        }
      });

      function formatHoursPretty(value) {
        const totalMinutes = Math.round(value * 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours}—á${minutes.toString().padStart(2, '0')}–º`;
      }
    }

    fetchData();
  </script>
</body>
</html>
