<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leads Projects Editor</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 24px;
    }
    .project-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    .project-card h2 {
      margin-top: 0;
      font-size: 20px;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
    }
    input[type="date"] {
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    .members {
      margin-bottom: 12px;
    }
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    button {
      padding: 10px 16px;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h1>Leads</h1>
  <div id="raw-response" style="background:#eee; padding:10px; margin-bottom:20px; border-radius:8px;">
    <strong>Raw Response:</strong>
    <pre id="json-output" style="white-space:pre-wrap;"></pre>
  </div>
  <div id="projects"></div>

  <script>
    async function loadProjects() {
      try {
        const tg = window.Telegram.WebApp;
        tg.expand();

        const telegram_id = tg?.initDataUnsafe?.user?.id || 217500012;
        console.log('Отправка запроса с telegram_id:', telegram_id);

        const res = await fetch('https://nip.setters-n8n.infinityfreeapp.com/webhook/leads-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id })
        });

        const data = await res.json();
        console.log('Результат запроса:', data);

        // ВЫВОД В HTML
        document.getElementById('json-output').textContent = JSON.stringify(data, null, 2);

        const container = document.getElementById('projects');
        container.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p>Нет доступных проектов.</p>';
          return;
        }

        data.forEach(project => {
          const card = document.createElement('div');
          card.className = 'project-card';

          const membersHTML = (project.members || [])
            .map(m => `${m.name} (${m.is_active ? 'active' : 'inactive'})`)
            .join('<br>');

          card.innerHTML = `
            <h2>${project.project_name}</h2>
            <div class="members">
              <strong>Members:</strong><br>
              ${membersHTML}
            </div>
            <label>Start Date</label>
            <input type="date" value="${project.start_date || ''}" id="start-${project.project_id}" />
            <label>End Date</label>
            <input type="date" value="${project.end_date || ''}" id="end-${project.project_id}" />
            <div class="toggle">
              <label>Archived</label>
              <input type="checkbox" id="archived-${project.project_id}" ${project.project_status === 'archive' ? 'checked' : ''} />
            </div>
            <button onclick="updateProject(${project.project_id})">Save</button>
          `;

          container.appendChild(card);
        });
      } catch (err) {
        console.error('Ошибка при загрузке проектов:', err);
        alert('❌ Ошибка при получении данных. Проверь консоль разработчика.');
      }
    }

    async function updateProject(projectId) {
      try {
        const startDate = document.getElementById(`start-${projectId}`).value;
        const endDate = document.getElementById(`end-${projectId}`).value;
        const isArchived = document.getElementById(`archived-${projectId}`).checked;

        const payload = {
          project_id: projectId,
          start_date: startDate,
          end_date: endDate,
          project_status: isArchived ? 'archive' : 'active'
        };

        const res = await fetch('https://nip.setters-n8n.infinityfreeapp.com/webhook/update-project-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        alert(result.success ? '✅ Обновлено' : `❌ Ошибка: ${result.reason || 'unknown'}`);
      } catch (err) {
        console.error('Ошибка при обновлении проекта:', err);
        alert('❌ Ошибка при отправке обновления.');
      }
    }

    loadProjects();
  </script>
</body>
</html>
